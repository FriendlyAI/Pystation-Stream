<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pystation Radio</title>
    <link rel="icon" type="image/png" href="favicon/192.png">
    <link rel="stylesheet" href="css/styles.css">
    <script src="javascript/jquery-3.3.1.min.js"></script>
</head>

<body>
    <audio id="stream" preload="none">
        <source src="http://pystation.mynetgear.com/main"/>
    </audio>

    <center>
        <h1 id="title">Loading...</h1>
        <input type="button" id="play_button" onclick="play()" value="Play">
        <br>
        <input type="checkbox" id="autoreload" value="autoreload"> Auto-reconnect<br>
        <br>
        <div class="slidecontainer">
            <input type="range" min="0" max="100" value="80" class="slider" id="volume">
        </div>
    </center>

    <div class="bottom">
    	<center>
    	    <h1 id="streamer">Loading...</h1>
    		<h2 id="genre">Loading...</h2>
    		<h2 id="description">Loading...</h2>	
    	</center>
	</div>

    <script>
        var slider = document.getElementById('volume');
        var stream = document.getElementById('stream');
        stream.volume = Math.pow(slider.value / 100, 3);

        slider.oninput = function() {
            stream.volume = Math.pow(this.value / 100, 3);
        }
    </script>

    <script>
        function play() {
            var stream = document.getElementById('stream');
            var button = document.getElementById('play_button');

            if (stream.paused) {
                stream.load();
                stream.play();
                button.value = 'Pause';
            }

            else {
                stream.pause();
                button.value = 'Play';
            }
        }
    </script>


    <script>
        var stream = document.getElementById('stream');
        var button = document.getElementById('play_button');
        var title = document.getElementById('title');
        var streamer = document.getElementById('streamer')
        var genre = document.getElementById('genre')
        var description = document.getElementById('description')
        var checkbox = document.getElementById('autoreload');

        function playing_check() {
        	setInterval(check_status, 500);

            function check_status() {
            	console.log('checking')
                if (stream.paused) {
                    button.value = 'Play';
                    if (checkbox.checked) {
                    	play()
                    }
                }
                get_title();
            }
        }

        function get_title() {
            fetch('http://pystation.mynetgear.com/status-json.xsl').then(response => {
                return response.json();
            }).then(data => {
                title.textContent = data['icestats']['source']['title'];
                streamer.textContent = 'Current streamer: ' + data['icestats']['source']['server_name'];
                genre.textContent = 'Genre: ' + data['icestats']['source']['genre'];
                description.textContent = 'Description: ' + data['icestats']['source']['server_description'];
            }).catch(err => {
                console.log(err);
            });
        }

        window.onload = playing_check;
    </script>
</body>
</html>